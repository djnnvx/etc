# USB/IP fuzzing VM — minimal kernel configuration fragment.
#
# Applied over `make allnoconfig` using:
#   scripts/kconfig/merge_config.sh -m .config ../qemu/kernel.config
#   make olddefconfig
#
# Goal: boots in QEMU in <2 seconds with USB/IP modules available.
# Strips everything not needed: no sound, no DRM, no filesystems beyond
# initramfs, no USB devices other than the IP-over-TCP stack.

# ── basic 64-bit SMP kernel ──────────────────────────────────────────────
CONFIG_64BIT=y
CONFIG_SMP=y
CONFIG_NR_CPUS=4
CONFIG_PREEMPT_NONE=y
CONFIG_HZ_100=y

# ── needed for kernel to function correctly ──────────────────────────────
CONFIG_PRINTK=y
CONFIG_BUG=y
CONFIG_ELF_CORE=n
CONFIG_FUTEX=y
CONFIG_EPOLL=y
CONFIG_SIGNALFD=y
CONFIG_EVENTFD=y
CONFIG_AIO=y
CONFIG_ADVISE_SYSCALLS=y
CONFIG_MEMFD_CREATE=y
CONFIG_POSIX_TIMERS=y

# ── memory ───────────────────────────────────────────────────────────────
CONFIG_MEMORY_ISOLATION=n
CONFIG_SLUB=y
# KASAN requires slab merging disabled — merged slabs collapse object types
# together, destroying redzone separation and defeating heap corruption detection
CONFIG_SLAB_MERGE_DEFAULT=n

# ── networking ───────────────────────────────────────────────────────────
CONFIG_NET=y
CONFIG_INET=y
CONFIG_PACKET=y
CONFIG_UNIX=y
CONFIG_IPV6=n
CONFIG_TCP_CONG_CUBIC=y
CONFIG_DEFAULT_TCP_CONG="cubic"
CONFIG_NETFILTER=n
CONFIG_NET_SCHED=n

# ── network device drivers ───────────────────────────────────────────────
CONFIG_NETDEVICES=y
CONFIG_ETHERNET=y
CONFIG_NET_VENDOR_INTEL=y
CONFIG_E1000=y             # QEMU default NIC (e1000)
CONFIG_VIRTIO_NET=y        # Faster option if using -device virtio-net-pci

# ── USB/IP (the actual target) ───────────────────────────────────────────
CONFIG_USB=y
CONFIG_USB_SUPPORT=y
CONFIG_USB_HCD_TEST_MODE=n
CONFIG_USB_PCI=y
CONFIG_USB_OHCI_HCD=y      # USB host controller in QEMU
CONFIG_USB_OHCI_HCD_PCI=y
CONFIG_USB_EHCI_HCD=y
CONFIG_USB_EHCI_PCI=y
CONFIG_USBIP_CORE=y
CONFIG_USBIP_HOST=y
CONFIG_USBIP_VHCI_HCD=y
CONFIG_USBIP_DEBUG=n

# ── modules (needed for modprobe in /init) ───────────────────────────────
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=n

# ── filesystem / initramfs ───────────────────────────────────────────────
CONFIG_TMPFS=y
CONFIG_PROC_FS=y
CONFIG_PROC_SYSCTL=y
CONFIG_SYSFS=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_BLK_DEV_INITRD=y
CONFIG_RD_GZIP=y
CONFIG_INITRAMFS_SOURCE=""

# ── TTY / serial console ─────────────────────────────────────────────────
CONFIG_TTY=y
CONFIG_VT=n
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y
CONFIG_SERIAL_8250_NR_UARTS=4

# ── PCI (needed for e1000) ───────────────────────────────────────────────
CONFIG_PCI=y
CONFIG_PCIEPORTBUS=y

# ── clock / timers ───────────────────────────────────────────────────────
CONFIG_RTC_CLASS=y

# ── disable as much as possible for fast boot ────────────────────────────
CONFIG_ACPI=n
CONFIG_ACPI_SLEEP=n
CONFIG_HIBERNATION=n
CONFIG_SUSPEND=n
CONFIG_PM=n
CONFIG_SOUND=n
CONFIG_DRM=n
CONFIG_FB=n
CONFIG_FRAMEBUFFER_CONSOLE=n
CONFIG_HID=n
CONFIG_INPUT=n
CONFIG_SERIO=n
CONFIG_WIRELESS=n
CONFIG_RFKILL=n
CONFIG_CRYPTO_HW=n

# ── sanitizers (KASAN, KCOV, UBSAN) ─────────────────────────────────────
# KASAN: catches heap overflows, UAF, OOB reads in kernel code.
# Without this, usbip_recv_xbuff / usbip_recv_iso heap overflows are invisible.
# Overhead: ~2x slowdown, 8x extra RAM for shadow memory. Increase -m to 512M.
CONFIG_KASAN=y
CONFIG_KASAN_GENERIC=y
CONFIG_KASAN_OUTLINE=y         # outline = smaller code, faster compile, same detection
CONFIG_KASAN_TAGS=n

# UBSAN: catches undefined behaviour (signed overflow, out-of-bounds, etc.)
CONFIG_UBSAN=y
CONFIG_UBSAN_BOUNDS=y
CONFIG_UBSAN_SANITIZE_ALL=y

# DEBUG_LIST: catches list corruption (double-free via list_del poisoning)
CONFIG_DEBUG_LIST=y

# KCOV: exports kernel PC coverage to userspace via /sys/kernel/debug/kcov.
# Needed for the KCOV shim that feeds kernel coverage into AFL++ bitmap.
CONFIG_KCOV=y
CONFIG_KCOV_ENABLE_COMPARISONS=y

# DEBUGFS: required by KCOV (mounts at /sys/kernel/debug)
CONFIG_DEBUG_FS=y

# Panic on oops: KASAN reports are oopses. This makes them immediately reboot
# the VM, which AFL++ detects as ECONNRESET → crash. Without this, a KASAN
# report prints and execution continues with corrupted state.
CONFIG_PANIC_ON_OOPS=y

# ── size optimization ────────────────────────────────────────────────────
# NOTE: CC_OPTIMIZE_FOR_SIZE is intentionally disabled with KASAN.
# KASAN adds heavy instrumentation that conflicts with aggressive size opts.
CONFIG_CC_OPTIMIZE_FOR_SIZE=n
CONFIG_KERNEL_XZ=n
CONFIG_KERNEL_GZIP=y
