function Run-SQL
{
    param (
        [Parameter(Mandatory=$true)]
        [string]$instance,

        [Parameter(Mandatory=$true)]
        [string]$query,

        [Parameter(Mandatory=$false)]
        [string]$username,

        [Parameter(Mandatory=$false)]
        [string]$password
    )

    try {
        $connectionString = "Server=$instance;"

        if ($PSCmdlet.MyInvocation.BoundParameters.ContainsKey('username')) {
            $credential = New-Object System.Data.SqlClient.SqlCredential($username, $password | ConvertTo-SecureString -AsPlainText -Force)
            $connection = New-Object System.Data.SqlClient.SqlConnection($connectionString)
            $connection.Credential = $credential
        }
        else {
            $connectionString += "Integrated Security=True;"
            $connection = New-Object System.Data.SqlClient.SqlConnection($connectionString)
        }

        using ($connection) {
            $connection.Open()
            $command = $connection.CreateCommand()
            $command.CommandText = $query

            $dataTable = New-Object System.Data.DataTable
            $dataTable.Load($command.ExecuteReader())

            return $dataTable
        }
    }
    catch {
        Write-Error "An error occurred while executing the SQL query: $($_.Exception.Message)"
        return $null
    }
}
